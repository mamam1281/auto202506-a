# 백엔드 초대코드 인증 시스템 변경사항

## 변경 개요
복잡한 JWT/나이인증/이메일 시스템을 제거하고 단순한 초대코드 기반 시스템으로 전환

## 🔧 백엔드 변경사항

### 1. 데이터베이스 모델 (app/models.py)

#### User 모델 단순화
```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    nickname = Column(String(50), unique=True, nullable=False)  # 이메일 제거
    invite_code = Column(String(6), nullable=False, index=True)  # 필수 초대코드
    cyber_token_balance = Column(Integer, default=200)
    created_at = Column(DateTime, default=datetime.utcnow)
    rank = Column(String(20), default="STANDARD", nullable=False)  # 랭크 시스템
```

#### 제거된 모델
- `UserSegment`: RFM 세그먼테이션 제거
- `AgeVerificationRecord`: 나이 인증 제거

#### AdultContent 모델 업데이트
```python
# 기존: required_segment_level
# 변경: required_rank (VIP/PREMIUM/STANDARD)
required_rank = Column(String(20), default="STANDARD", nullable=False)
```

### 2. 인증 시스템 (app/auth/)

#### 새로운 파일: simple_auth.py
- JWT 인증 완전 제거
- 초대코드 검증 로직
- 랭크 기반 접근 제어

```python
class SimpleAuth:
    @staticmethod
    def generate_invite_code() -> str
    
    @staticmethod  
    def register_with_invite_code(invite_code: str, nickname: str, db) -> User
    
    @staticmethod
    def check_rank_access(user_rank: str, required_rank: str) -> bool
```

#### 제거된 파일
- `jwt.py`: JWT 인증 로직 삭제

### 3. API 라우터 (app/routers/)

#### 새로운 파일: auth_simple.py
```python
# 주요 엔드포인트
POST /auth/register         # 초대코드로 가입
POST /auth/invite-codes     # 관리자용 초대코드 생성  
GET /auth/invite-codes      # 초대코드 목록 조회
GET /auth/users/{nickname}  # 사용자 조회
```

#### 기존 auth.py 
- JWT 기반 복잡한 인증 로직 유지 (호환성)
- 향후 완전 교체 예정

### 4. 스키마 (app/schemas.py)

#### 추가된 스키마
```python
class UserRegister(BaseModel):
    invite_code: str = Field(..., min_length=6, max_length=6)
    nickname: str = Field(..., min_length=2, max_length=50)

class UserResponse(BaseModel):
    id: int
    nickname: str
    rank: str  # VIP, PREMIUM, STANDARD
    cyber_token_balance: int
    created_at: datetime

class InviteCodeCreate(BaseModel):
    count: int = Field(default=1, ge=1, le=100)

class InviteCodeResponse(BaseModel):
    id: int
    code: str
    is_used: bool
    created_at: datetime
```

## 📊 랭크 시스템

### 랭크 계층구조
```python
rank_hierarchy = {
    "VIP": 3,      # 모든 서비스 접근
    "PREMIUM": 2,  # 프리미엄 콘텐츠
    "STANDARD": 1  # 기본 서비스
}
```

### 접근 제어 로직
```python
def check_rank_access(user_rank: str, required_rank: str) -> bool:
    user_level = rank_hierarchy.get(user_rank, 1)
    required_level = rank_hierarchy.get(required_rank, 1)
    return user_level >= required_level
```

## 🗄️ 데이터베이스 마이그레이션 필요사항

### 1. 테이블 구조 변경
```sql
-- User 테이블
ALTER TABLE users DROP COLUMN email;
ALTER TABLE users DROP COLUMN password_hash;
ALTER TABLE users DROP COLUMN segment_label;
ALTER TABLE users ADD COLUMN rank VARCHAR(20) DEFAULT 'STANDARD';
ALTER TABLE users ALTER COLUMN invite_code SET NOT NULL;

-- AdultContent 테이블  
ALTER TABLE adult_content DROP COLUMN required_segment_level;
ALTER TABLE adult_content ADD COLUMN required_rank VARCHAR(20) DEFAULT 'STANDARD';

-- 제거할 테이블
DROP TABLE user_segments;
DROP TABLE age_verification_records;
```

### 2. 데이터 마이그레이션
```sql
-- 기존 사용자들 기본 랭크 설정
UPDATE users SET rank = 'STANDARD' WHERE rank IS NULL;

-- 기존 AdultContent 랭크 매핑
UPDATE adult_content SET required_rank = 
  CASE 
    WHEN required_segment_level >= 3 THEN 'VIP'
    WHEN required_segment_level = 2 THEN 'PREMIUM' 
    ELSE 'STANDARD'
  END;
```

## 🔑 데모용 초대코드
- `VIP2024`: VIP 등급 (모든 서비스)
- `DEMO99`: PREMIUM 등급 (프리미엄 콘텐츠)
- `TEST01`: STANDARD 등급 (기본 서비스)

## ⚠️ 주의사항
1. 기존 JWT 기반 auth.py는 호환성을 위해 유지
2. 점진적 마이그레이션 후 완전 교체 예정
3. 사용자 데이터 백업 후 마이그레이션 수행 필요
